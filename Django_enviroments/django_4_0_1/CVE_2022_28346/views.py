from django.shortcuts import HttpResponse
from CVE_2022_28346.models import Book
from django.db.models import Avg, Sum


# Create your views here.
def book_list_view(request):
    alias = request.GET.get("alias", None)
    func = request.GET.get("func", None)

    response = "<h2>Book List</h2>"

    if func == "aggregate" and alias:
        aggregate_param = request.GET.get("aggregate_param", "price")
        data = Book.objects.aggregate(**{alias: Avg(aggregate_param)})
        response += "<p>{alias}: {value:.2f}</p>".format(
            alias=alias.capitalize(), value=data[alias]
        )  # 将小数位数限制为两位
    elif (func == "annotate" or func == "extra") and alias:
        if func == "annotate":
            queryset = Book.objects.annotate(**{alias: Sum("price")})
        else:
            queryset = Book.objects.extra(
                select={alias: "price"}, where=["price > 20"]
            )

        if queryset.exists():
            response += "<table><thead><tr><th>Name</th><th>{alias}</th></tr></thead><tbody>".format(
                alias=alias.capitalize()
            )
            for book in queryset:
                response += "<tr><td>{name}</td><td>{value:.2f}</td></tr>".format(
                    name=book.name, value=getattr(book, alias)
                )
            response += "</tbody></table>"
        else:
            response += "<p>No books found.</p>"
    else:
        books = Book.objects.all()
        response += "<table><thead><tr><th>Name</th><th>Pages</th><th>Price</th><th>Rating</th><th>Pubdate</th></tr></thead><tbody>"
        for book in books:
            response += "<tr><td>{name}</td><td>{pages}</td><td>{price}</td><td>{rating}</td><td>{pubdate}</td></tr>".format(
                name=book.name,
                pages=book.pages,
                price=book.price,
                rating=book.rating,
                pubdate=book.pubdate,
            )
        response += "</tbody></table>"

    return HttpResponse(response)
