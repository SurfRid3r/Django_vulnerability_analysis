from django.shortcuts import render
from django.contrib.postgres.aggregates import StringAgg
from django.db.models import Value
from CVE_2020_7471.models import Author,Book
# Create your views here.


def author_books(request):
    delimiter = request.GET.get("delimiter", ", ")
    author_name = request.GET.get("name")
    if author_name:
        authors = Author.objects.filter(name=author_name)
    else:
        authors = Author.objects.all()

    books_by_author = {}
    for author_i in authors:
        books = Book.objects.filter(author=author_i).aggregate(result=StringAgg("title", delimiter=delimiter))["result"]
        books_by_author[author_i] = books

    context = {"authors": authors, "books_by_author": books_by_author}
    return render(request, "author_books.html", context)